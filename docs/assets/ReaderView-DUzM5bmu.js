import{C as e,D as t,E as n,F as r,I as i,L as a,M as o,N as s,O as c,P as l,R as u,T as d,_ as f,b as p,f as m,g as h,h as g,k as _,m as v,p as y,t as ee,u as te,v as b,w as x,x as S,z as C}from"./vendor-BQYTT8JO.js";import{t as w}from"./search-CKcgQAWs.js";import{c as ne,d as re,f as ie,h as ae,l as oe,n as se,o as ce,p as T,r as le,s as ue,t as de}from"./profiles-CJJEMCwS.js";import{t as fe}from"./epub-BkcVe20u.js";function pe(e){let t=e.classList.contains(`noteref`)||e.classList.contains(`footnote-ref`)||e.classList.contains(`footnoteRef`)||e.classList.contains(`endnote`)||e.classList.contains(`endnote-ref`),n=e.getAttribute(`role`)===`doc-noteref`,r=(e.getAttribute(`epub:type`)||``).split(/\s+/).includes(`noteref`),i=(e.getAttribute(`rel`)||``).split(/\s+/).includes(`footnote`),a=e.getAttribute(`href`)||``,o=a.includes(`#`)&&/#(fn[-_]?|footnote|note|endnote)/i.test(a);return t||n||r||i||o}async function me(e){let t=e.trim();if(!t)return null;try{let e=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(t)}`);if(!e.ok)return null;let n=await e.json(),r=[];for(let e of n||[])for(let t of e.meanings||[])for(let e of t.definitions||[])e.definition&&r.push(e.definition);return r.length?r.slice(0,6).join(`
`):null}catch{return null}}function he(e){let t=e.match(/^\s*(\d{1,3}\s*[:.]\s*\d{1,3})\b/)?.[1];if(t)return t.replace(/\s+/g,``);let n=e.match(/^\s*(\d{1,4})\b/)?.[1];if(n)return n}function E(e){return String(e??``).replace(/\s+/g,` `).trim()}function ge(e,t){let n=E(e),r=E(t);if(/^Sura\b/i.test(n))return n;if(/^Sura\b/i.test(r))return r;for(let e of[n,r]){if(!e)continue;let t=e.match(/(Sura\b[^|/>]+)$/i)||e.match(/(Sura\b[^|/>]+)/i);if(t?.[1])return E(t[1])}}function _e(e,t){let n=E(e),r=E(t);return n?`Translated by ${n}. ${r}.`:`${r}.`}function ve(e){let t=E(e.selectedText),n=he(t);if(e.profile===`quran`){let n=ge(e.section,e.chapter),r=_e(e.author,e.title);return n?`“${t}”\n${n}\n\n— ${r}`:`“${t}”\n\n— ${r}`}return`"${t}"\n\n— ${de(e.profile,{title:e.title,author:e.author,section:e.section??e.chapter,verseHint:n})}`}var D=3;function ye(){return new w.Index({tokenize:`forward`,resolution:9,cache:100})}function O(e){return(e||``).replace(/\s+/g,` `).trim()}function k(e,t){let n=O(e),r=n.toLowerCase().indexOf(t.toLowerCase());if(r<0)return n.slice(0,180)+(n.length>180?`…`:``);let i=Math.max(0,r-60),a=Math.min(n.length,r+t.length+100);return(i>0?`…`:``)+n.slice(i,a)+(a<n.length?`…`:``)}function A(e){if(e&&typeof e==`object`&&e.nodeType===9){let t=e;return O(t.body?.textContent||t.documentElement?.textContent||``)}let t=typeof e==`string`?e:String(e??``),n=new DOMParser,r=n.parseFromString(t,`application/xhtml+xml`);return r.getElementsByTagName(`parsererror`).length&&(r=n.parseFromString(t,`text/html`)),O(r.body?.textContent||r.documentElement?.textContent||``)}async function be(e,t,n){let r=ye(),i=await oe(e),a=i?.hrefText??{},o=i?.v,s=Object.values(a).reduce((e,t)=>e+(t?.length||0),0);(o!==D||s<500)&&(a={});let c=Object.keys(a);if(c.length>0){for(let e of c){let t=a[e];t&&r.add(e,t.toLowerCase())}return n?.(c.length,c.length,!0),{idx:r,hrefText:a,fromCache:!0}}let l=t?.spine?.items??[],u=l.length;for(let e=0;e<l.length;e++){let i=l[e]?.href;if(!i){n?.(e+1,u,!1);continue}try{let e=A(await t.load(i));e&&(a[i]=e,r.add(i,e.toLowerCase()))}catch{}n?.(e+1,u,!1),e%3==0&&await new Promise(e=>setTimeout(e,0))}return await T(e,{v:D,hrefText:a,updatedAt:Date.now()}),{idx:r,hrefText:a,fromCache:!1}}function xe(e,t){let n=0,r=-1,i=0;for(;;){let a=e.indexOf(t,i);if(a<0)break;r<0&&(r=a),n++,i=a+Math.max(1,t.length)}return{count:n,first:r}}function Se(e,t,n){let r=O(n);if(!r)return[];let i=r.toLowerCase(),a=[];for(let e of Object.keys(t)){let n=O(t[e]||``);if(!n)continue;let{count:o,first:s}=xe(n.toLowerCase(),i);o<=0||s<0||a.push({href:e,count:o,snippet:k(n,r)})}return a.sort((e,t)=>t.count-e.count),a}var j=`universal_reader_db`,M=1;async function N(){return ee(j,M,{upgrade(e){e.createObjectStore(`books`,{keyPath:`id`}),e.createObjectStore(`prefs`,{keyPath:`bookId`}),e.createObjectStore(`sessions`,{keyPath:`id`}),e.createObjectStore(`search`,{keyPath:`bookId`}),e.createObjectStore(`meta`,{keyPath:`key`})}})}async function P(e){await(await N()).put(`sessions`,e)}async function F(e){return(await(await N()).getAll(`sessions`)).filter(t=>t.bookId===e)}function I(){return crypto.randomUUID?.()??`${Date.now()}-${Math.random()}`}async function Ce(e){let t={id:I(),bookId:e,startAt:Date.now()};return await P(t),t}async function we(e,t,n){let r=await(await N()).get(`sessions`,t);if(!r||r.bookId!==e)return;let i=Date.now(),a=Math.max(0,Math.round((i-r.startAt)/1e3));await P({...r,endAt:i,seconds:a,lastHref:n??r.lastHref})}async function Te(e){let t=await F(e);return{totalSeconds:t.reduce((e,t)=>e+(t.seconds??0),0),totalSessions:t.filter(e=>e.endAt).length}}function Ee(e){return String(e??``).replace(/\s+/g,` `).trim()}var De={class:`h-full bg-base-100`},Oe={key:0,class:`fixed top-0 left-0 right-0 z-30 bg-base-200/95 backdrop-blur border-b border-base-300`},ke={class:`navbar`},Ae={class:`flex-1 min-w-0`},je={class:`ml-2 truncate font-semibold`},Me={class:`px-3 pb-3`},Ne={key:0,class:`mt-2 flex items-center gap-2 text-xs opacity-70`},Pe={key:1,class:`text-xs opacity-60 mt-1`},Fe={key:2,class:`text-xs opacity-60 mt-1`},Ie={key:3,class:`mt-2 max-h-56 overflow-auto bg-base-100 rounded-xl border border-base-300`},Le={class:`max-h-64 overflow-auto border border-base-300 rounded-md`},Re=[`onClick`],ze={class:`text-xs opacity-60`},Be={class:`text-sm`},Ve={class:`p-3 grid grid-cols-2 sm:grid-cols-4 gap-3`},He={class:`form-control`},Ue={class:`form-control`},We={class:`form-control`},Ge={class:`form-control`},Ke={class:`form-control col-span-2`},qe={class:`form-control col-span-2`},Je={class:`form-control col-span-2`},Ye={class:`form-control`},Xe={class:`form-control`},Ze={class:`flex items-center gap-2 cursor-pointer`},Qe={class:`flex items-center gap-2 cursor-pointer`},$e={key:4,class:`modal modal-open`},et={class:`modal-box max-w-2xl`},tt={class:`mt-4 max-h-[70vh] overflow-auto space-y-1`},nt=[`onClick`],rt={class:`text-xs opacity-70 mt-2`},it={key:0},at={key:1},ot={key:0,class:`mt-3 text-sm opacity-70`},st={key:1,class:`mt-3 max-h-80 overflow-auto bg-base-100 rounded-xl border border-base-300`},ct=[`onClick`],lt={class:`text-xs opacity-60`},ut={class:`text-sm`},dt={key:0,class:`opacity-70`},ft=[`innerHTML`],L=x({__name:`ReaderView`,props:{id:{}},setup(ee){let x=r(le),w=ee,oe=te(),T=r(!1),de=r(null),he=r(null),E=r(24);function ge(){T.value=!0,d(()=>de.value?.focus())}function _e(){T.value=!1}let D=r(null),O=r(!0),k=r(null),A=r(`default`),xe=0,j=r(!1),M=r(``),N=r([]),P=null,F={},I=r(!1),L=r(0),pt=r(0),mt=r(!1),R=r(null),z=r(null),B=r(!1),ht=r([]),gt=f(()=>{let e=[],t=(n,r)=>{for(let i of n??[])i?.href&&e.push({href:i.href,label:i.label||i.href,depth:r}),i?.subitems?.length&&t(i.subitems,r+1)};return t(ht.value,0),e});function _t(){B.value=!0}function vt(){B.value=!1}async function yt(e){vt(),O.value=!0,await Gt(e.href)}function bt(e){e.key===`Escape`&&(O.value=!0,B.value=!1,T.value=!1),(e.key===`t`||e.key===`T`)&&O.value&&(B.value=!B.value)}function xt(e,t,n){let r=t.trim();if(!r)return{range:null,total:0};let i=[],a=e.createTreeWalker(e.body,NodeFilter.SHOW_TEXT);for(;a.nextNode();){let e=a.currentNode;e.data&&e.data.trim()&&i.push(e)}let o=i.map(e=>e.data).join(``).toLowerCase(),s=r.toLowerCase(),c=[],l=0;for(;;){let e=o.indexOf(s,l);if(e<0)break;c.push(e),l=e+Math.max(1,s.length)}let u=c.length;if(!u)return{range:null,total:u};let d=c[Math.max(0,Math.min(u-1,n))];if(d==null)return{range:null,total:u};let f=d,p=f+r.length,m=null,h=null,g=0,_=0,v=0;for(let e of i){let t=e.data.length;if(!m&&f<v+t&&(m=e,g=f-v),!h&&p<=v+t){h=e,_=p-v;break}v+=t}if(!m)return{range:null,total:u};h||(h=m,_=Math.min(m.data.length,g+r.length));let y=e.createRange();return y.setStart(m,Math.max(0,g)),y.setEnd(h,Math.max(0,_)),{range:y,total:u}}async function St(e,t,n){let r=e?.document;if(!r?.body)return{total:0};let{range:i,total:a}=xt(r,t,n);if(!i)return{total:a};let o=i.getBoundingClientRect(),s=e.window,c=s.scrollY+o.top-s.innerHeight*.33;s.scrollTo({top:Math.max(0,c),behavior:`instant`});try{let e=s.getSelection?.();e?.removeAllRanges?.(),e?.addRange?.(i)}catch{}return{total:a}}async function Ct(e){let t=M.value.trim();if(Nt(),O.value=!0,!t){z.value=null,await q.display(e.href);return}z.value={href:e.href,query:t,occurrence:0,total:0},R.value={href:e.href,query:t,occurrence:0},await q.display(e.href)}async function wt(e){let t=z.value;if(!t||!t.query)return;if(!t.total){R.value={href:t.href,query:t.query,occurrence:t.occurrence},await q.display(t.href);return}t.occurrence=(t.occurrence+e+t.total)%t.total;let n=(q?.location?.start?.href||``).split(`#`)[0],r=(t.href||``).split(`#`)[0];if(n&&r&&n===r){let e=(q?.getContents?.()??[])[0];e&&await St(e,t.query,t.occurrence);return}R.value={href:t.href,query:t.query,occurrence:t.occurrence},await q.display(t.href)}let V=r(!1),H=r(``),U=r(``),W=r(null),G=r(!1),K=null,q=null,J=null,Tt=f(()=>O.value?`pt-24`:`pt-0`),Et=f(()=>O.value?`pb-32`:`pb-0`),Dt={},Ot=!1;function Y(e){let t=decodeURIComponent(e||``).replace(/^#/,``).trim(),n=t.replace(/^fn-/,``),r=new Set([t,n,`fn-${n}`,t.replace(/_/g,`-`),t.replace(/-/g,`_`),n.replace(/_/g,`-`),n.replace(/-/g,`_`),`fn-${n.replace(/_/g,`-`)}`,`fn-${n.replace(/-/g,`_`)}`]);for(let e of Array.from(r))r.add(e.toLowerCase());return[...r].filter(Boolean)}function kt(e){if(e&&typeof e==`object`&&e.nodeType===9)return e;let t=typeof e==`string`?e:String(e??``),n=new DOMParser().parseFromString(t,`application/xhtml+xml`);return n.getElementsByTagName(`parsererror`).length&&(n=new DOMParser().parseFromString(t,`text/html`)),n}function At(e){let t=window.CSS;return t?.escape?t.escape(e):e.replace(/([ !"#$%&'()*+,./:;<=>?@[\\\]^`{|}~])/g,`\\$1`)}function jt(e,t){return e.getElementById(t)??e.querySelector(`#${At(t)}`)??null}async function Mt(){if(Ot||!K)return;Ot=!0;let e=new Set;for(let t of K.spine?.items??[])t?.href&&e.add(Q(t.href));let t=K?.packaging?.manifest??K?.manifest;if(t&&typeof t==`object`)for(let n of Object.keys(t)){let r=t[n],i=r?.href,a=r?.type||r?.media_type||r?.mediaType;i&&(!a||/x?html/i.test(a))&&e.add(Q(i))}for(let t of e){let e;try{e=await Promise.race([K.load(t),new Promise((e,t)=>setTimeout(()=>t(Error(`book.load timeout`)),2500))])}catch{continue}let n=kt(e),r=new Set;n.querySelectorAll(`#inline-footnotes [id]`).forEach(e=>r.add(e)),n.querySelectorAll(`.footnote[id]`).forEach(e=>r.add(e)),n.querySelectorAll(`[role="doc-footnote"][id]`).forEach(e=>r.add(e)),n.querySelectorAll(`[epub\\:type~="footnote"][id]`).forEach(e=>r.add(e));for(let e of r){let n=e.getAttribute(`id`)||``;if(!n)continue;let r=e.cloneNode(!0),i=r.querySelector(`.sr-only strong`)?.textContent?.trim()||r.querySelector(`.sr-only`)?.textContent?.trim()||void 0;r.querySelectorAll(`.sr-only`).forEach(e=>e.remove()),r.querySelectorAll(`script, iframe, object, embed`).forEach(e=>e.remove());let a=`<div class="space-y-2 leading-relaxed">${r.innerHTML}</div>`;for(let e of Y(n))Dt[e]={title:i,html:a,href:t}}}}function X(e,t){H.value=e,U.value=t,V.value=!0}function Nt(){V.value=!1}function Pt(e){let t=e.target?.closest?.(`a`)??null;if(!t)return;let n=t.getAttribute(`href`)||``;if(n){if(Bt(n)||pe(t)){e.preventDefault();let r=W.value||q?.location?.start?.href||k.value?.lastHref||``;Ft(n,(t.textContent||``).trim(),r);return}/^(https?:|mailto:|tel:)/i.test(n)||(e.preventDefault(),Gt(n))}}async function Ft(e,t,n){let[r,i]=e.split(`#`),a=(r||``).trim(),o=(i||``).trim();if(!o)return;let s=Rt(o).replace(/^#/,``);G.value=!0,H.value=`Loading…`,U.value=``;try{let{doc:e,hrefUsed:r}=await Jt(a,null,n);for(let i of Y(s)){let a=jt(e,i);if(a){let e=a.cloneNode(!0),i=e.querySelector(`.sr-only strong`)?.textContent?.trim()||e.querySelector(`.sr-only`)?.textContent?.trim()||t||s;e.querySelectorAll(`.sr-only`).forEach(e=>e.remove()),e.querySelectorAll(`script, iframe, object, embed`).forEach(e=>e.remove()),H.value=i,U.value=`<div class="space-y-2 leading-relaxed">${e.innerHTML}</div>`,W.value=r||n;return}}await Mt();for(let e of Y(s)){let r=Dt[e];if(r){H.value=r.title||t||s,U.value=r.html,W.value=r.href||n;return}}let i=s.replace(/^fn-/,``),o=await me(i);H.value=t||i,U.value=o?`<pre class="whitespace-pre-wrap">${$(o)}</pre>`:`<p>No definition found.</p>`}finally{G.value=!1}}async function It(){J&&await we(w.id,J),oe.push(`/`)}function Z(){if(!q)return;let e=x.value.noterefUnderline?`underline`:`none`;q.themes.register(`user`,{body:{background:x.value.bg,color:x.value.fg,"font-family":x.value.font,"line-height":String(x.value.lineHeight),margin:`${x.value.marginEm}em`,"text-align":`${x.value.textAlign} !important`,"padding-bottom":`${E.value}px`},p:{"text-align":`${x.value.textAlign} !important`},'a.noteref, a[role="doc-noteref"], a[rel~="footnote"], a[epub\\:type~="noteref"]':{color:x.value.noterefColor,"text-decoration":`${e} !important`}}),q.themes.select(`user`),q.themes.fontSize(`${x.value.fontSizePct}%`)}function Lt(){O.value=!O.value}function Rt(e){try{return decodeURIComponent(e)}catch{return e}}function Q(e){let t=(e||``).replace(/\\/g,`/`).replace(/\/+/g,`/`).replace(/^\/+/g,``),n=[];for(let e of t.split(`/`))!e||e===`.`||(e===`..`?n.pop():n.push(e));return n.join(`/`)}function zt(e,t){let n=(e||``).replace(/\/+/g,`/`).replace(/\/+$/g,``),r=(t||``).replace(/\/+/g,`/`).replace(/^\/+/g,``);return Q(n?`${n}/${r}`:r)}function Bt(e){return!!e&&e.includes(`#`)&&/#(fn[-_]?|footnote|note|endnote)/i.test(e)}async function Vt(){await d();let e=O.value&&he.value?he.value.offsetHeight:0;E.value=Math.max(24,e+24),Z()}o(O,()=>Vt()),t(()=>window.addEventListener(`resize`,Vt)),n(()=>window.removeEventListener(`resize`,Vt));async function Ht(e){let t=await ue(),n=t.findIndex(e=>e.id===w.id);if(n<0)return;let r=t[n];r&&(t[n]={...r,...e},await re(t),k.value=t[n]??null)}async function Ut(){if(!K)return{idx:ye(),hrefText:{},fromCache:!1};j.value=!0,I.value=!1;try{console.info(`[search] init`,{spine:K.spine?.items?.length??0});let e=await be(w.id,K,(e,t,n)=>{L.value=e,pt.value=t,mt.value=n});P=e.idx,F=e.hrefText;let t=Object.values(F).reduce((e,t)=>e+(t?.length||0),0),n=Object.entries(F)[0];console.info(`[search] text`,{totalChars:t,firstHref:n?.[0],firstSample:n?.[1]?.slice(0,120)}),I.value=!0,N.value=M.value.trim()?Se(P,F,M.value.trim()):[],console.info(`[search] ready`,{chapters:Object.keys(F).length,fromCache:e.fromCache}),window.__readerDebug={status:()=>({ready:I.value,done:L.value,total:pt.value,fromCache:mt.value,chapters:Object.keys(F).length}),search:e=>P?Se(P,F,e):[]}}catch(e){console.error(`[search] failed`,e)}finally{j.value=!1}}let Wt=null;o(M,()=>{Wt&&window.clearTimeout(Wt);let e=M.value.trim();if(!e||!I.value||!P){N.value=[];return}Wt=window.setTimeout(()=>{N.value=Se(P,F,e)},200)}),o(O,()=>Z());async function Gt(e){Nt(),O.value=!0,await q.display(e)}async function Kt(){let e=await Te(w.id);X(`Reading analytics`,`<p>Total: <b>${Math.round(e.totalSeconds/60)}</b> minutes across <b>${e.totalSessions}</b> sessions.</p>`)}function qt(e,t,n){let r=Rt(t||``).trim(),i=Rt(e||``).trim(),a=Q(r),o=Q(i),s=o.includes(`/`)?o.slice(0,o.lastIndexOf(`/`)+1):``,c=new Set;a&&c.add(zt(s,a)),a&&c.add(a);let l=[];for(let e of n?.spine?.items??[]){let t=e?.href;t&&l.push(Q(t))}let u=n?.packaging?.manifest??n?.manifest;if(u&&typeof u==`object`)for(let e of Object.keys(u)){let t=u[e],n=t?.href,r=t?.type||t?.media_type||t?.mediaType;n&&(!r||/x?html/i.test(r))&&l.push(Q(n))}let d=a.split(`/`).pop()||a;for(let e of l)e&&(e===a||e.endsWith(`/`+a)||e.endsWith(`/`+d)||e===d)&&c.add(e);return[...c]}async function Jt(e,t,n){let r=n||q?.location?.start?.href||k.value?.lastHref||``;if(!e)return t?{doc:t,hrefUsed:r}:r?{doc:kt(await Promise.race([K.load(r),new Promise((e,t)=>setTimeout(()=>t(Error(`book.load timeout`)),2500))])),hrefUsed:r}:{doc:document.implementation.createHTMLDocument(``),hrefUsed:``};let i=qt(r,e,K),a=null;for(let e of i)try{return{doc:kt(await Promise.race([K.load(e),new Promise((e,t)=>setTimeout(()=>t(Error(`book.load timeout`)),2500))])),hrefUsed:e}}catch(e){a=e}throw a??Error(`Could not load referenced file`)}async function Yt(e,t,n){let r=e.getAttribute(`href`)||``,i=(e.textContent||``).trim();if(!r||/^(https?:|mailto:|tel:)/i.test(r))return;let[a,o]=r.split(`#`),s=(a||``).trim(),c=(o||``).trim();if(!c)return;let l=Rt(c).replace(/^#/,``);G.value=!0,V.value=!0,H.value=`Loading…`,U.value=``,W.value=null;let u=(e,t,n)=>{let r=e.cloneNode(!0),a=t||r.querySelector(`.sr-only strong`)?.textContent?.trim()||r.querySelector(`.sr-only`)?.textContent?.trim()||i||l;r.querySelectorAll(`.sr-only`).forEach(e=>e.remove()),r.querySelectorAll(`script, iframe, object, embed`).forEach(e=>e.remove()),H.value=a,U.value=`<div class="space-y-2 leading-relaxed">${r.innerHTML}</div>`,W.value=n};try{for(let e of Y(l)){let r=jt(t,e);if(r){u(r,void 0,n||q?.location?.start?.href||k.value?.lastHref||``);return}}try{let{doc:e,hrefUsed:r}=await Jt(s,s?null:t,n);for(let t of Y(l)){let i=jt(e,t);if(i){u(i,void 0,r||n);return}}}catch{}await Mt();for(let e of Y(l)){let t=Dt[e];if(t){H.value=t.title||i||l,U.value=t.html,W.value=t.href||n;return}}let e=l.replace(/^fn-/,``),r=await me(e);H.value=i||e,U.value=r?`<pre class="whitespace-pre-wrap">${$(r)}</pre>`:`<p>No definition found.</p>`}finally{G.value=!1}}function $(e){return e.replace(/[&<>"']/g,e=>({"&":`&amp;`,"<":`&lt;`,">":`&gt;`,'"':`&quot;`,"'":`&#39;`})[e])}async function Xt(e){try{let t=await K.getRange(e),n=Ee(t?.toString());if(!n)return;let r=Zt(t)??await Qt(),i=(A.value===`quran`?Zt(t,e=>/^sura\b/i.test(e))??void 0:void 0)??r,a=ve({profile:A.value,selectedText:n,title:k.value?.title||`Untitled`,author:k.value?.author,section:i,chapter:i});X(`Selection`,`
          <p class="opacity-70">${$(n)}</p>
          <div class="mt-3 flex flex-wrap gap-2">
            <button id="btn-quote" class="btn btn-primary btn-sm">Copy quote</button>
            <button id="btn-define" class="btn btn-outline btn-sm">Define first word</button>
          </div>
        `),setTimeout(()=>{let e=document.getElementById(`btn-quote`),t=document.getElementById(`btn-define`);e?.addEventListener(`click`,async()=>{await navigator.clipboard.writeText(a),X(`Copied`,`<p>Quote copied with citation.</p>`)}),t?.addEventListener(`click`,async()=>{let e=n.split(/\s+/)[0]||``,t=await me(e);X(`Define: ${$(e)}`,t?`<pre class="whitespace-pre-wrap">${$(t)}</pre>`:`<p>No definition found.</p>`)})},0)}catch{}}function Zt(e,t){let n=q?.location?.start?.href||k.value?.lastHref;if(!n)return;let r=n.split(`#`)[0],i=gt.value.filter(e=>(e.href||``).split(`#`)[0]===r);if(!i.length)return;let a=e.startContainer?.ownerDocument;if(a){let n=null;for(let r of i){if(t&&!t(r.label))continue;let i=(r.href||``).split(`#`)[1];if(!i)continue;let o=a.getElementById(i);if(o)try{let t=a.createRange();t.selectNode(o),t.compareBoundaryPoints(Range.START_TO_START,e)<=0&&(!n||r.depth>n.depth||n&&r.depth===n.depth)&&(n=r)}catch{}}if(n)return n.label}let o=t?i.filter(e=>t(e.label)):i;if(!o.length)return;let s=o[0];for(let e of o)(e.depth>s.depth||e.depth===s.depth)&&(s=e);return s.label}async function Qt(){try{let e=q?.location?.start?.href;return(K?.navigation?.toc??[]).find(t=>t.href&&e&&t.href.split(`#`)[0]===e.split(`#`)[0])?.label??void 0}catch{return}}async function $t(){let e=(await ue()).find(e=>e.id===w.id)||null;if(k.value=e,!e){oe.push(`/`);return}let t=await ce(w.id);if(!t){oe.push(`/`);return}K=fe(await t.arrayBuffer()),await K.ready,ht.value=K.navigation?.toc??[],K.spine.hooks.serialize.register(e=>e.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,``));let n=await K.loaded.metadata,r=Ee(n?.title)||e.title,i=Ee(n?.creator)||e.author||``,a=``;try{let e=K.spine.items?.[0]?.href,t=await K.load(e);a=(new DOMParser().parseFromString(String(t),`text/html`).body?.textContent||``).slice(0,6e3)}catch{}A.value=se(r,i,a),await Ht({title:r,author:i,profile:A.value}),q=K.renderTo(D.value,{width:`100%`,height:`100%`,spread:`none`,manager:`continuous`,flow:`scrolled-doc`}),q.on(`rendered`,async(e,t)=>{let n=R.value;if(!n)return;let r=(e?.href||``).split(`#`)[0],i=(n.href||``).split(`#`)[0];if(!r||r!==i)return;R.value=null;let a=await St(t,n.query,n.occurrence);z.value&&z.value.href.split(`#`)[0]===i&&(z.value.total=a.total,z.value.occurrence=Math.min(z.value.occurrence,Math.max(0,a.total-1)))}),q.hooks.content.register(e=>{let t=e.document;t.querySelectorAll(`script`).forEach(e=>e.remove());try{e.addStylesheetRules({"#inline-footnotes":{display:`none !important`},".sr-only":{display:`none !important`}})}catch{}t.addEventListener(`click`,async n=>{let r=n.target?.closest?.(`a`);if(r){if(r&&pe(r)){n.preventDefault(),n.stopPropagation(),await Yt(r,t,e?.section?.href||q?.location?.start?.href||k.value?.lastHref||``);return}if(x.value.studyMode&&!r){let e=t.getSelection?.();if(e&&e.toString().trim())return;let r=Date.now();if(r-xe<250)return;xe=r,O.value=!O.value,n.preventDefault(),n.stopPropagation()}}},!0)}),q.on(`selected`,e=>Xt(e)),q.on(`relocated`,async e=>{let t=e?.start?.cfi,n=e?.start?.href,r=e?.start?.percentage;await Ht({lastCfi:t,lastHref:n,lastProgress:r})}),await q.display(e.lastCfi||void 0),Z(),J=(await Ce(w.id)).id,Ut()}return o(()=>x.value.studyMode,e=>{e?O.value=!1:O.value=!0}),o(x,async()=>{await ie(w.id,x.value),Z()},{deep:!0}),t(async()=>{window.addEventListener(`keydown`,bt),x.value=await ne(w.id).catch(()=>le),await $t()}),n(async()=>{window.removeEventListener(`keydown`,bt);try{q&&q.destroy()}catch{}try{K&&K.destroy?.()}catch{}if(q=null,K=null,J)try{await we(w.id,J)}catch{}}),(t,n)=>(c(),S(`div`,De,[O.value?(c(),S(`div`,Oe,[b(`div`,ke,[b(`div`,Ae,[b(`button`,{class:`btn btn-ghost btn-sm`,onClick:It},`← Library`),b(`div`,je,C(k.value?.title),1)]),b(`div`,{class:`flex-none gap-2`},[b(`button`,{class:`btn btn-sm`,onClick:_t},`TOC`),b(`button`,{class:`btn btn-sm btn-outline`,onClick:Kt},`Stats`)])]),b(`div`,Me,[l(b(`input`,{class:`input input-bordered w-full`,placeholder:`Search in book…`,"onUpdate:modelValue":n[0]||=e=>M.value=e},null,512),[[v,M.value]]),z.value&&z.value.query===M.value.trim()&&z.value.total>0?(c(),S(`div`,Ne,[b(`span`,null,`Match `+C(z.value.occurrence+1)+` / `+C(z.value.total),1),b(`button`,{class:`btn btn-xs btn-outline`,onClick:n[1]||=g(e=>wt(-1),[`stop`])},`Prev`),b(`button`,{class:`btn btn-xs btn-outline`,onClick:n[2]||=g(e=>wt(1),[`stop`])},`Next`)])):p(``,!0),j.value?(c(),S(`div`,Pe,` Indexing `+C(L.value)+`/`+C(pt.value)+`… `,1)):I.value?(c(),S(`div`,Fe,` Search ready (`+C(Object.keys(i(F)).length)+` chapters`+C(mt.value?`, cached`:``)+`) `,1)):p(``,!0),N.value.length?(c(),S(`div`,Ie,[b(`div`,Le,[(c(!0),S(h,null,_(N.value,e=>(c(),S(`div`,{key:e.href,class:`p-2 hover:bg-base-200 cursor-pointer`,onClick:t=>Ct(e)},[b(`div`,ze,C(e.href)+` · `+C(e.count)+` match`+C(e.count===1?``:`es`),1),b(`div`,Be,C(e.snippet),1)],8,Re))),128))])])):p(``,!0)])])):p(``,!0),b(`div`,{class:a([[Tt.value,Et.value],`h-full`]),onClick:Lt},[b(`div`,{ref_key:`viewer`,ref:D,class:`h-full w-full`},null,512)],2),O.value?(c(),S(`div`,{key:1,ref_key:`bottomChromeEl`,ref:he,class:`fixed bottom-0 left-0 right-0 z-30 bg-base-200/95 backdrop-blur border-t border-base-300`,onClick:n[12]||=g(()=>{},[`stop`])},[b(`div`,Ve,[b(`label`,He,[n[15]||=b(`div`,{class:`label`},[b(`span`,{class:`label-text`},`Font size`)],-1),l(b(`input`,{type:`range`,min:`80`,max:`180`,step:`5`,"onUpdate:modelValue":n[3]||=e=>x.value.fontSizePct=e,class:`range range-sm`},null,512),[[v,x.value.fontSizePct,void 0,{number:!0}]])]),b(`label`,Ue,[n[16]||=b(`div`,{class:`label`},[b(`span`,{class:`label-text`},`Line height`)],-1),l(b(`input`,{type:`range`,min:`1.2`,max:`2.2`,step:`0.05`,"onUpdate:modelValue":n[4]||=e=>x.value.lineHeight=e,class:`range range-sm`},null,512),[[v,x.value.lineHeight,void 0,{number:!0}]])]),b(`label`,We,[n[17]||=b(`div`,{class:`label`},[b(`span`,{class:`label-text`},`Background`)],-1),l(b(`input`,{type:`color`,"onUpdate:modelValue":n[5]||=e=>x.value.bg=e,class:`input input-bordered h-10 p-1`},null,512),[[v,x.value.bg]])]),b(`label`,Ge,[n[18]||=b(`div`,{class:`label`},[b(`span`,{class:`label-text`},`Text`)],-1),l(b(`input`,{type:`color`,"onUpdate:modelValue":n[6]||=e=>x.value.fg=e,class:`input input-bordered h-10 p-1`},null,512),[[v,x.value.fg]])]),b(`label`,Ke,[n[20]||=b(`div`,{class:`label`},[b(`span`,{class:`label-text`},`Font`)],-1),l(b(`select`,{class:`select select-bordered`,"onUpdate:modelValue":n[7]||=e=>x.value.font=e},[...n[19]||=[b(`option`,{value:`ui-serif, Georgia, "Times New Roman", Times, serif`},`Serif`,-1),b(`option`,{value:`ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`},`Sans`,-1),b(`option`,{value:`ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace`},`Mono`,-1)]],512),[[y,x.value.font]])]),b(`label`,qe,[n[22]||=b(`div`,{class:`label`},[b(`span`,{class:`label-text`},`Alignment`)],-1),l(b(`select`,{class:`select select-bordered`,"onUpdate:modelValue":n[8]||=e=>x.value.textAlign=e},[...n[21]||=[b(`option`,{value:`left`},`Left`,-1),b(`option`,{value:`justify`},`Justify`,-1),b(`option`,{value:`center`},`Center`,-1),b(`option`,{value:`right`},`Right`,-1)]],512),[[y,x.value.textAlign]])]),b(`label`,Je,[b(`label`,Ye,[n[23]||=b(`div`,{class:`label`},[b(`span`,{class:`label-text`},`Glossary link color`)],-1),l(b(`input`,{type:`color`,"onUpdate:modelValue":n[9]||=e=>x.value.noterefColor=e,class:`input input-bordered h-10 p-1`},null,512),[[v,x.value.noterefColor]])]),b(`label`,Xe,[n[25]||=b(`div`,{class:`label`},[b(`span`,{class:`label-text`},`Underline glossary links`)],-1),b(`label`,Ze,[l(b(`input`,{type:`checkbox`,class:`toggle`,"onUpdate:modelValue":n[10]||=e=>x.value.noterefUnderline=e},null,512),[[m,x.value.noterefUnderline]]),n[24]||=b(`span`,{class:`text-sm opacity-70`},`Toggle`,-1)])]),n[27]||=b(`div`,{class:`label`},[b(`span`,{class:`label-text`},`Study mode`)],-1),b(`label`,Qe,[l(b(`input`,{type:`checkbox`,class:`toggle`,"onUpdate:modelValue":n[11]||=e=>x.value.studyMode=e},null,512),[[m,x.value.studyMode]]),n[26]||=b(`span`,{class:`text-sm opacity-70`},`Hide UI (tap screen to show/hide)`,-1)])])])],512)):p(``,!0),O.value?p(``,!0):(c(),S(`button`,{key:2,class:`fixed z-50 btn btn-sm btn-circle`,style:{top:`calc(env(safe-area-inset-top) + 0.75rem)`,right:`3.25rem`},onClick:g(ge,[`stop`]),"aria-label":`Search`},[...n[28]||=[b(`svg`,{xmlns:`http://www.w3.org/2000/svg`,class:`h-4 w-4`,viewBox:`0 0 24 24`,fill:`none`,stroke:`currentColor`,"stroke-width":`2`},[b(`circle`,{cx:`11`,cy:`11`,r:`7`}),b(`path`,{d:`M21 21l-4.3-4.3`})],-1)]])),O.value?p(``,!0):(c(),S(`button`,{key:3,class:`fixed z-50 btn btn-sm opacity-80 hover:opacity-100`,style:{top:`calc(env(safe-area-inset-top) + 0.75rem)`,right:`0.75rem`},onClick:n[13]||=e=>O.value=!0,"aria-label":`Show controls`},` Show controls `)),B.value?(c(),S(`div`,$e,[b(`div`,et,[b(`div`,{class:`flex items-center justify-between gap-3`},[n[29]||=b(`h3`,{class:`font-bold text-lg`},`Table of contents`,-1),b(`button`,{class:`btn btn-sm`,onClick:vt},`Close`)]),b(`div`,tt,[(c(!0),S(h,null,_(gt.value,(e,t)=>(c(),S(`button`,{key:t,class:`btn btn-ghost btn-sm w-full justify-start text-left`,style:u({paddingLeft:`${e.depth*.75}rem`}),onClick:t=>yt(e)},C(e.label),13,nt))),128))])]),b(`div`,{class:`modal-backdrop`,onClick:vt})])):p(``,!0),e(ae,{open:T.value,title:`Search`,onClose:_e},{default:s(()=>[l(b(`input`,{ref_key:`searchInputEl`,ref:de,class:`input input-bordered w-full`,placeholder:`Search in book…`,"onUpdate:modelValue":n[14]||=e=>M.value=e},null,512),[[v,M.value]]),b(`div`,rt,[j.value?(c(),S(`span`,it,`Indexing…`)):(c(),S(`span`,at,`Search ready (`+C(Object.keys(i(F)).length)+` chapters`+C(mt.value?`, cached`:``)+`)`,1))]),M.value.trim()&&!j.value&&!N.value.length?(c(),S(`div`,ot,` No matches. `)):p(``,!0),N.value.length?(c(),S(`div`,st,[(c(!0),S(h,null,_(N.value,e=>(c(),S(`div`,{key:e.href+e.snippet,class:`p-2 hover:bg-base-200 cursor-pointer`,onClick:t=>{Ct(e),_e()}},[b(`div`,lt,C(e.href)+` · `+C(e.count)+` match`+C(e.count===1?``:`es`),1),b(`div`,ut,C(e.snippet),1)],8,ct))),128))])):p(``,!0)]),_:1},8,[`open`]),e(ae,{open:V.value,title:H.value,onClose:Nt},{default:s(()=>[G.value?(c(),S(`div`,dt,`Loading…`)):(c(),S(`div`,{key:1,class:`space-y-2`,onClick:Pt,innerHTML:U.value},null,8,ft))]),_:1},8,[`open`,`title`])]))}});export{L as default};