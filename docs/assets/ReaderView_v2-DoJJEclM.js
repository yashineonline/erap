import{C as e,D as t,E as n,F as r,L as i,M as a,N as o,O as s,P as c,R as l,S as u,T as d,_ as f,b as p,f as ee,g as te,h as m,k as ne,m as h,p as re,t as ie,u as ae,v as g,w as _,x as v,z as y}from"./vendor-BQYTT8JO.js";import{t as oe}from"./search-CKcgQAWs.js";import{t as b}from"./index-XFD9lqe9.js";import{_ as se,c as ce,f as le,l as x,m as S,n as ue,o as de,p as fe,r as pe,s as me,t as he}from"./profiles-CHS8_GvS.js";import{t as ge}from"./epub-BkcVe20u.js";function _e(e){let t=e.classList.contains(`noteref`)||e.classList.contains(`footnote-ref`)||e.classList.contains(`footnoteRef`)||e.classList.contains(`endnote`)||e.classList.contains(`endnote-ref`),n=e.getAttribute(`role`)===`doc-noteref`,r=(e.getAttribute(`epub:type`)||``).split(/\s+/).includes(`noteref`),i=(e.getAttribute(`rel`)||``).split(/\s+/).includes(`footnote`),a=e.getAttribute(`href`)||``,o=a.includes(`#`)&&/#(fn[-_]?|footnote|note|endnote)/i.test(a);return t||n||r||i||o}async function ve(e){let t=e.trim();if(!t)return null;try{let e=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(t)}`);if(!e.ok)return null;let n=await e.json(),r=[];for(let e of n||[])for(let t of e.meanings||[])for(let e of t.definitions||[])e.definition&&r.push(e.definition);return r.length?r.slice(0,6).join(`
`):null}catch{return null}}function ye(e){let t=e.match(/^\s*(\d{1,3}\s*[:.]\s*\d{1,3})\b/)?.[1];if(t)return t.replace(/\s+/g,``);let n=e.match(/^\s*(\d{1,4})\b/)?.[1];if(n)return n}function C(e){return String(e??``).replace(/\s+/g,` `).trim()}function be(e,t){let n=C(e),r=C(t);if(/^Sura\b/i.test(n))return n;if(/^Sura\b/i.test(r))return r;for(let e of[n,r]){if(!e)continue;let t=e.match(/(Sura\b[^|/>]+)$/i)||e.match(/(Sura\b[^|/>]+)/i);if(t?.[1])return C(t[1])}}function xe(e,t){let n=C(e),r=C(t);return n?`Translated by ${n}. ${r}.`:`${r}.`}function Se(e){let t=C(e.selectedText),n=ye(t);if(e.profile===`quran`){let n=be(e.section,e.chapter),r=xe(e.author,e.title);return n?`“${t}”\n${n}\n\n— ${r}`:`“${t}”\n\n— ${r}`}return`"${t}"\n\n— ${he(e.profile,{title:e.title,author:e.author,section:e.section??e.chapter,verseHint:n})}`}var w=3;function T(){return new oe.Index({tokenize:`forward`,resolution:9,cache:100})}function E(e){return(e||``).replace(/\s+/g,` `).trim()}function Ce(e,t){let n=E(e),r=n.toLowerCase().indexOf(t.toLowerCase());if(r<0)return n.slice(0,180)+(n.length>180?`…`:``);let i=Math.max(0,r-60),a=Math.min(n.length,r+t.length+100);return(i>0?`…`:``)+n.slice(i,a)+(a<n.length?`…`:``)}function we(e){if(e&&typeof e==`object`&&e.nodeType===9){let t=e;return E(t.body?.textContent||t.documentElement?.textContent||``)}let t=typeof e==`string`?e:String(e??``),n=new DOMParser,r=n.parseFromString(t,`application/xhtml+xml`);return r.getElementsByTagName(`parsererror`).length&&(r=n.parseFromString(t,`text/html`)),E(r.body?.textContent||r.documentElement?.textContent||``)}async function Te(e,t,n){let r=T(),i=await x(e),a=i?.hrefText??{},o=i?.v,s=Object.values(a).reduce((e,t)=>e+(t?.length||0),0);(o!==w||s<500)&&(a={});let c=Object.keys(a);if(c.length>0){for(let e of c){let t=a[e];t&&r.add(e,t.toLowerCase())}return n?.(c.length,c.length,!0),{idx:r,hrefText:a,fromCache:!0}}let l=t?.spine?.items??[],u=l.length;for(let e=0;e<l.length;e++){let i=l[e]?.href;if(!i){n?.(e+1,u,!1);continue}try{let e=we(await t.load(i));e&&(a[i]=e,r.add(i,e.toLowerCase()))}catch{}n?.(e+1,u,!1),e%3==0&&await new Promise(e=>setTimeout(e,0))}return await S(e,{v:w,hrefText:a,updatedAt:Date.now()}),{idx:r,hrefText:a,fromCache:!1}}function D(e,t){let n=0,r=-1,i=0;for(;;){let a=e.indexOf(t,i);if(a<0)break;r<0&&(r=a),n++,i=a+Math.max(1,t.length)}return{count:n,first:r}}function Ee(e,t,n){let r=E(n);if(!r)return[];let i=r.toLowerCase(),a=[];for(let e of Object.keys(t)){let n=E(t[e]||``);if(!n)continue;let{count:o,first:s}=D(n.toLowerCase(),i);o<=0||s<0||a.push({href:e,count:o,snippet:Ce(n,r)})}return a.sort((e,t)=>t.count-e.count),a}var O=`universal_reader_db`,De=1;async function k(){return ie(O,De,{upgrade(e){e.createObjectStore(`books`,{keyPath:`id`}),e.createObjectStore(`prefs`,{keyPath:`bookId`}),e.createObjectStore(`sessions`,{keyPath:`id`}),e.createObjectStore(`search`,{keyPath:`bookId`}),e.createObjectStore(`meta`,{keyPath:`key`})}})}async function Oe(e){await(await k()).put(`sessions`,e)}async function ke(e){return(await(await k()).getAll(`sessions`)).filter(t=>t.bookId===e)}function Ae(){return crypto.randomUUID?.()??`${Date.now()}-${Math.random()}`}async function je(e){let t={id:Ae(),bookId:e,startAt:Date.now()};return await Oe(t),t}async function Me(e,t,n){let r=await(await k()).get(`sessions`,t);if(!r||r.bookId!==e)return;let i=Date.now(),a=Math.max(0,Math.round((i-r.startAt)/1e3));await Oe({...r,endAt:i,seconds:a,lastHref:n??r.lastHref})}async function Ne(e){let t=await ke(e);return{totalSeconds:t.reduce((e,t)=>e+(t.seconds??0),0),totalSessions:t.filter(e=>e.endAt).length}}function Pe(e){return String(e??``).replace(/\s+/g,` `).trim()}var Fe={class:`h-full bg-base-100`},Ie={class:`navbar`},Le={class:`flex-1 min-w-0`},Re={class:`ml-2 truncate font-semibold`},ze={class:`flex-none gap-2`},Be={class:`join hidden sm:inline-flex`},Ve=[`disabled`],He=[`disabled`],Ue={key:0,class:`join`},We=[`disabled`],Ge=[`disabled`],Ke={class:`p-3 grid grid-cols-2 sm:grid-cols-4 gap-3`},qe={class:`form-control`},Je={class:`form-control`},Ye={class:`form-control`},Xe={class:`form-control`},Ze={class:`form-control col-span-2`},Qe={class:`form-control col-span-2`},$e={class:`col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-3`},et={class:`form-control`},tt={class:`form-control`},nt={class:`form-control sm:col-span-2`},rt={class:`label cursor-pointer justify-start gap-3`},it={class:`form-control sm:col-span-2`},at={class:`label cursor-pointer justify-start gap-3`},ot={key:0,class:`form-control sm:col-span-2`},st={class:`mt-2`},ct=[`value`],lt={key:4,class:`modal modal-open`},ut={class:`modal-box max-w-2xl`},dt={class:`mt-4 max-h-[70vh] overflow-auto space-y-1`},ft=[`onClick`],pt={class:`mt-3`},mt={class:`join w-full`},ht=[`disabled`],gt=[`disabled`],_t={class:`mt-1 text-xs opacity-70 flex items-center justify-between gap-3`},vt={key:0},yt={key:1},bt={key:2},xt={key:0,class:`mt-4`},St={class:`max-h-72 overflow-auto space-y-2`},Ct=[`onClick`],wt={class:`flex items-center justify-between gap-3`},Tt={class:`text-sm font-semibold`},Et={class:`text-xs opacity-70 truncate`},Dt={class:`mt-1 text-sm opacity-80 line-clamp-3`},Ot={key:1,class:`mt-3 text-sm opacity-70`},kt={key:0,class:`opacity-70`},At=[`innerHTML`],jt=b(_({__name:`ReaderView_v2`,props:{id:{}},setup(ie){let _=ie,oe=ae(),b=r(null),x=r(!0),S=r(null),he=r(null),ye=r(0),C=r(0),be=r(24),xe=f(()=>({paddingTop:x.value?`${ye.value}px`:`0px`,paddingBottom:x.value?`${C.value}px`:`0px`})),w=r(!1),T=r(``),E=r(``),Ce=r(!1),we=r(null),D=r(!1),O=r(!1),De=r(null);function k(e,t){T.value=e,E.value=t,w.value=!0}function Oe(){w.value=!1}function ke(){O.value=!0,d(()=>De.value?.focus())}function Ae(){O.value=!1}function jt(){D.value=!0}function Mt(){D.value=!1}let A=r(pe),j=r(null),Nt=r(`default`),M=f({get:()=>!!(A.value?.realBookFeel??!1),set:e=>{A.value.realBookFeel=e,V()}}),N=f({get:()=>!!(A.value?.readAloud??!1),set:e=>{A.value.readAloud=e,e||$(),V()}}),Pt=f({get:()=>Number(A.value?.ttsRate??1),set:e=>{A.value.ttsRate=e,V()}}),Ft=f({get:()=>String(A.value?.ttsVoiceURI??``),set:e=>{A.value.ttsVoiceURI=e,V()}}),P=null,F=null,I=null;function L(e){return e.replace(/[&<>"']/g,e=>({"&":`&amp;`,"<":`&lt;`,">":`&gt;`,'"':`&quot;`,"'":`&#39;`})[e])}function R(e){let t=(e||``).replace(/\\/g,`/`).replace(/\/+/,`/`).replace(/^\/+/,``),n=[];for(let e of t.split(`/`))!e||e===`.`||(e===`..`?n.pop():n.push(e));return n.join(`/`)}function It(e){let t=e??``;try{return decodeURIComponent(t)}catch{return t}}function z(e){return R(It(e).replace(/#.*$/,``))}function Lt(e){let t=window.CSS;return t?.escape?t.escape(e):e.replace(/([ !"#$%&'()*+,./:;<=>?@[\\\]^`{|}~])/g,`\\$1`)}function Rt(e){if(e&&typeof e==`object`&&e.nodeType===9)return e;let t=typeof e==`string`?e:String(e??``),n=new DOMParser().parseFromString(t,`application/xhtml+xml`);return n.getElementsByTagName(`parsererror`).length&&(n=new DOMParser().parseFromString(t,`text/html`)),n}function zt(e,t){return e.getElementById(t)??e.querySelector(`#${Lt(t)}`)??null}function Bt(e){let t=decodeURIComponent(e||``).replace(/^#/,``).trim(),n=t.replace(/^fn-/,``),r=new Set([t,n,`fn-${n}`,t.replace(/_/g,`-`),t.replace(/-/g,`_`),n.replace(/_/g,`-`),n.replace(/-/g,`_`),`fn-${n.replace(/_/g,`-`)}`,`fn-${n.replace(/-/g,`_`)}`]);for(let e of Array.from(r))r.add(e.toLowerCase());return[...r].filter(Boolean)}async function Vt(e){let t=await me(),n=t.findIndex(e=>e.id===_.id);if(n<0)return;let r=t[n];r&&(t[n]={...r,...e},await le(t),j.value=t[n]??null)}async function B(){await d();let e=x.value&&S.value?S.value.offsetHeight:0,t=x.value&&he.value?he.value.offsetHeight:0;ye.value=e,C.value=t,be.value=Math.max(24,t+24),Ht()}a(x,B),t(()=>{B(),window.addEventListener(`resize`,B)}),n(()=>{window.removeEventListener(`resize`,B)});function Ht(){if(!F)return;let e=A.value.noterefUnderline?`underline`:`none`;F.themes.register(`user`,{body:{background:A.value.bg,color:A.value.fg,"font-family":A.value.font,"line-height":String(A.value.lineHeight),margin:`${A.value.marginEm}em`,"text-align":`${A.value.textAlign} !important`,"padding-bottom":`${be.value}px`},p:{"text-align":`${A.value.textAlign} !important`},"a.noteref, a[role='doc-noteref'], a[rel~='footnote'], a[epub\\:type~='noteref']":{color:A.value.noterefColor,"text-decoration":`${e} !important`},".reader-search-hit":{background:`rgba(250, 204, 21, 0.45)`,"border-radius":`0.15em`,padding:`0 0.08em`}}),F.themes.select(`user`),F.themes.fontSize(`${A.value.fontSizePct}%`)}async function V(){await fe(_.id,A.value),Ht()}a(A,async()=>{await fe(_.id,A.value),Ht()},{deep:!0});let Ut=r([]),Wt=f(()=>{let e=[],t=(n,r)=>{for(let i of n??[])i?.href&&e.push({href:i.href,label:i.label||i.href,depth:r}),i?.subitems?.length&&t(i.subitems,r+1)};return t(Ut.value,0),e});async function Gt(e){Mt(),x.value=!0,await Yt(e.href)}function Kt(e){e.key===`Escape`&&(x.value=!0,D.value=!1,O.value=!1,w.value=!1),(e.key===`t`||e.key===`T`)&&x.value&&(D.value=!D.value)}let qt=r(0);async function Jt(){I&&await Me(_.id,I),oe.push(`/`)}async function Yt(e){Oe(),x.value=!0,await F?.display?.(e)}let H=r(null);async function Xt(){if(F){H.value=M.value?`next`:null;try{await F.next()}finally{H.value&&window.setTimeout(()=>H.value=null,220)}}}async function Zt(){if(F){H.value=M.value?`prev`:null;try{await F.prev()}finally{H.value&&window.setTimeout(()=>H.value=null,220)}}}let U=r(!1),W=r(!1),Qt=r(0),$t=r(0),en=r(!1),G=r(``),K=r([]),tn=null,nn=r({}),rn=r({}),an=r([]),q=r(!1),on=f(()=>{let e=new Map;for(let t of K.value)t.hrefCanon&&e.set(t.hrefCanon,t.count||0);return e}),sn=f(()=>{let e=on.value,t=new Set(Object.keys(nn.value).map(z));return(an.value.length?an.value:[...t]).filter(n=>n&&t.has(n)&&e.has(n))}),J=f(()=>{let e=on.value;return sn.value.reduce((t,n)=>t+(e.get(n)??0),0)});function cn(e){let t=on.value,n=sn.value,r=0;for(let i of n){let n=t.get(i)??0;if(e<r+n)return{hrefCanon:i,occ:e-r};r+=n}return{hrefCanon:n[0],occ:0}}function ln(){return z(String(F?.location?.start?.href||``))}function un(e){let t=F?.getContents?.()??[];return t.find(t=>z(String(t?.section?.href||t?.href||``))===e)??t[0]}function dn(e){let t=Array.from(e.querySelectorAll(`span.reader-search-hit`));for(let e of t){let t=e.parentNode;if(t){for(;e.firstChild;)t.insertBefore(e.firstChild,e);t.removeChild(e),t.normalize?.()}}}function fn(e,t){dn(e);let n=e.createElement(`span`);n.className=`reader-search-hit`;try{t.surroundContents(n)}catch{}}function pn(e,t,n){let r=t.trim();if(!r)return{range:null,total:0};let i=r.toLowerCase(),a=e=>{let t=e.parentElement;return t?!!t.closest(`nav, aside, [role='doc-footnote'], [epub\\:type~='footnote'], .footnote, .endnote, #inline-footnotes, script, style`):!1},o=0,s=null,c=null,l=e.createTreeWalker(e.body,4);for(;l.nextNode();){let t=l.currentNode;if(!t.data||!t.data.trim()||a(t))continue;let u=t.data.toLowerCase(),d=0;for(;;){let a=u.indexOf(i,d);if(a<0)break;let l=e.createRange();l.setStart(t,a),l.setEnd(t,a+r.length),o===n&&(s=l),c=l,o++,d=a+Math.max(1,i.length)}}return o?{range:s??c,total:o}:{range:null,total:0}}async function mn(e,t,n){let r=e?.document;if(!r?.body)return{total:0};let{range:i,total:a}=pn(r,t,n);if(!i)return{total:a};let o=e.window,s=i.startContainer?.parentElement;return s?.scrollIntoView&&(s.scrollIntoView({block:`center`,behavior:`instant`}),o.scrollBy({top:-Math.round(o.innerHeight*.12),behavior:`instant`})),fn(r,i),{total:a}}let hn=r(null),Y=r(null);async function gn(e){let t=G.value.trim();if(!t||!W.value||!tn||q.value)return;let n=J.value;if(!n)return;(!Y.value||Y.value.query!==t)&&(Y.value={query:t,global:e>0?-1:0,total:n});let r=(Y.value.global+e+n)%n;Y.value.global=r,Y.value.total=n;let{hrefCanon:i,occ:a}=cn(r),o=ln(),s=rn.value[i]??i;if(o&&o===i){let e=un(i);e&&await mn(e,t,a);return}hn.value={hrefCanon:i,query:t,occurrence:a},await F.display(s)}async function _n(){if(P){U.value=!0,W.value=!1;try{let e=await Te(_.id,P,(e,t,n)=>{Qt.value=e,$t.value=t,en.value=n});tn=e.idx,nn.value=e.hrefText;let t={};for(let n of Object.keys(e.hrefText))t[z(n)]=n;rn.value=t,an.value=(P?.spine?.items??[]).map(e=>z(String(e?.href||``))).filter(Boolean),W.value=!0,K.value=G.value.trim()?vn(G.value.trim()):[]}catch(e){console.error(`[search] init failed`,e)}finally{U.value=!1}}}function vn(e){return Ee(tn,nn.value,e).map(e=>({hrefKey:e.href,hrefCanon:z(e.href),snippet:e.snippet,count:e.count}))}let yn=null;a(G,()=>{yn&&window.clearTimeout(yn);let e=G.value.trim();if(!e||!W.value||!tn){K.value=[],Y.value=null;return}yn=window.setTimeout(()=>{K.value=vn(e),Y.value?.query===e&&(Y.value.total=J.value,Y.value.global=Math.min(Y.value.global,Math.max(-1,Y.value.total-1)))},180)});async function bn(e){let t=G.value.trim();t&&(Y.value={query:t,global:-1,total:J.value},hn.value={hrefCanon:e.hrefCanon,query:t,occurrence:0},await F.display(e.hrefKey))}let X=f(()=>typeof window<`u`&&`speechSynthesis`in window),xn=r([]),Z=r(!1),Q=r(!1);function Sn(){if(X.value)try{xn.value=window.speechSynthesis.getVoices()||[]}catch{xn.value=[]}}function Cn(e){if(e)return xn.value.find(t=>t?.voiceURI===e)}function wn(e,t=240){let n=(e||``).replace(/\s+/g,` `).trim();if(!n)return[];let r=[],i=``,a=n.split(/[\.!?]\s+/).filter(Boolean);for(let e of a)(i+` `+e).trim().length>t&&i.trim()?(r.push(i.trim()),i=e):i=(i+` `+e).trim();return i.trim()&&r.push(i.trim()),r}function Tn(){let e=(F?.getContents?.()??[])[0]?.document;if(!e?.body)return``;let t=e.body.cloneNode(!0);return t.querySelectorAll(`nav, aside, #inline-footnotes, .footnote, .endnote, script, style`).forEach(e=>e.remove()),(t.innerText||t.textContent||``).trim()}function En(){N.value=!N.value}function $(){if(X.value){try{window.speechSynthesis.cancel()}catch{}Z.value=!1,Q.value=!1}}function Dn(){if(X.value)try{window.speechSynthesis.pause(),Q.value=!0}catch{}}function On(){if(X.value)try{window.speechSynthesis.resume(),Q.value=!1}catch{}}async function kn(){if(!X.value)return;$(),Sn();let e=Tn();if(!e){k(`Read aloud`,`<p class='opacity-70'>No readable text found on this page.</p>`);return}let t=wn(e.slice(0,12e3));if(!t.length)return;let n=Cn(Ft.value);Z.value=!0,Q.value=!1;let r=0,i=()=>{if(!Z.value)return;if(r>=t.length){Z.value=!1,Q.value=!1;return}let e=new window.SpeechSynthesisUtterance(t[r]);n&&(e.voice=n),e.rate=Math.min(1.4,Math.max(.6,Pt.value||1)),e.onend=()=>{r++,i()},e.onerror=()=>{Z.value=!1,Q.value=!1},window.speechSynthesis.speak(e)};i()}function An(e){return!!e&&e.includes(`#`)&&/#(fn[-_]?|footnote|note|endnote)/i.test(e)}async function jn(e,t,n){let r=n||F?.location?.start?.href||j.value?.lastHref||``;if(!e)return t?{doc:t,hrefUsed:r}:r?{doc:Rt(await Promise.race([P.load(r),new Promise((e,t)=>setTimeout(()=>t(Error(`book.load timeout`)),2500))])),hrefUsed:r}:{doc:document.implementation.createHTMLDocument(``),hrefUsed:``};let i=R(It(e||``).trim()),a=R(It(r||``).trim()),o=a.includes(`/`)?a.slice(0,a.lastIndexOf(`/`)+1):``,s=new Set;i&&s.add(R(o?`${o}/${i}`:i)),i&&s.add(i);let c=[];for(let e of P?.spine?.items??[]){let t=e?.href;t&&c.push(R(t))}let l=P?.packaging?.manifest??P?.manifest;if(l&&typeof l==`object`)for(let e of Object.keys(l)){let t=l[e],n=t?.href,r=t?.type||t?.media_type||t?.mediaType;n&&(!r||/x?html/i.test(r))&&c.push(R(n))}let u=i.split(`/`).pop()||i;for(let e of c)e&&(e===i||e.endsWith(`/`+i)||e.endsWith(`/`+u)||e===u)&&s.add(e);let d=null;for(let e of s)try{return{doc:Rt(await Promise.race([P.load(e),new Promise((e,t)=>setTimeout(()=>t(Error(`book.load timeout`)),2500))])),hrefUsed:e}}catch(e){d=e}throw d??Error(`Could not load referenced file`)}async function Mn(e,t,n){let[r,i]=e.split(`#`),a=(r||``).trim(),o=(i||``).trim();if(!o)return;let s=It(o).replace(/^#/,``);Ce.value=!0,w.value=!0,T.value=`Loading…`,E.value=``;try{let{doc:e,hrefUsed:r}=await jn(a,null,n);for(let i of Bt(s)){let a=zt(e,i);if(!a)continue;let o=a.cloneNode(!0),c=o.querySelector(`.sr-only strong`)?.textContent?.trim()||o.querySelector(`.sr-only`)?.textContent?.trim()||t||s;o.querySelectorAll(`.sr-only`).forEach(e=>e.remove()),o.querySelectorAll(`script, iframe, object, embed`).forEach(e=>e.remove()),T.value=c,E.value=`<div class="space-y-2 leading-relaxed">${o.innerHTML}</div>`,we.value=r||n;return}let i=s.replace(/^fn-/,``),o=await ve(i);T.value=t||i,E.value=o?`<pre class="whitespace-pre-wrap">${L(o)}</pre>`:`<p>No definition found.</p>`}finally{Ce.value=!1}}function Nn(e){let t=e.target?.closest?.(`a`)??null;if(!t)return;let n=t.getAttribute(`href`)||``;if(n){if(An(n)||_e(t)){e.preventDefault();let r=we.value||F?.location?.start?.href||j.value?.lastHref||``;Mn(n,(t.textContent||``).trim(),r);return}/^(https?:|mailto:|tel:)/i.test(n)||(e.preventDefault(),Yt(n))}}async function Pn(e){try{let t=Pe((await P.getRange(e))?.toString());if(!t)return;let n=Se({profile:Nt.value,selectedText:t,title:j.value?.title||`Untitled`,author:j.value?.author,section:await Fn(),chapter:await Fn()});k(`Selection`,`
        <p class="opacity-70">${L(t)}</p>
        <div class="mt-3 flex flex-wrap gap-2">
          <button id="btn-quote" class="btn btn-primary btn-sm">Copy quote</button>
          <button id="btn-define" class="btn btn-outline btn-sm">Define first word</button>
        </div>
      `),setTimeout(()=>{let e=document.getElementById(`btn-quote`),r=document.getElementById(`btn-define`);e?.addEventListener(`click`,async()=>{await navigator.clipboard.writeText(n),k(`Copied`,`<p>Quote copied with citation.</p>`)}),r?.addEventListener(`click`,async()=>{let e=t.split(/\s+/)[0]||``,n=await ve(e);k(`Define: ${L(e)}`,n?`<pre class="whitespace-pre-wrap">${L(n)}</pre>`:`<p>No definition found.</p>`)})},0)}catch{}}async function Fn(){try{let e=F?.location?.start?.href;return(P?.navigation?.toc??[]).find(t=>t.href&&e&&t.href.split(`#`)[0]===e.split(`#`)[0])?.label??void 0}catch{return}}function In(){try{F?.destroy?.()}catch{}F=null}function Ln(){F&&(F.on(`rendered`,async(e,t)=>{let n=hn.value;if(!n)return;let r=z(e?.href||``);!r||r!==n.hrefCanon||(hn.value=null,await mn(t,n.query,n.occurrence))}),F.on(`selected`,e=>Pn(e)),F.on(`relocated`,async e=>{let t=e?.start?.cfi,n=e?.start?.href,r=e?.start?.percentage;await Vt({lastCfi:t,lastHref:n,lastProgress:r}),N.value&&Z.value&&$()}),F.hooks.content.register(e=>{let t=e.document;try{e.addStylesheetRules({"#inline-footnotes":{display:`none !important`},".sr-only":{display:`none !important`}})}catch{}let n=()=>{let e=t.getSelection?.();q.value=!!e&&!!e.toString().trim()};if(t.addEventListener(`selectionchange`,n),t.addEventListener(`pointerup`,n,{passive:!0}),t.addEventListener(`pointerdown`,()=>{q.value=!1},{passive:!0}),t.querySelectorAll(`script`).forEach(e=>e.remove()),t.addEventListener(`click`,async n=>{let r=n.target?.closest?.(`a`)??null;if(r&&_e(r)){n.preventDefault(),n.stopPropagation(),await Mn(r.getAttribute(`href`)||``,(r.textContent||``).trim(),e?.section?.href||F?.location?.start?.href||j.value?.lastHref||``);return}if(A.value.studyMode&&!r){if(O.value||D.value||w.value)return;let e=t.getSelection?.();if(e&&e.toString().trim())return;let r=Date.now();if(r-qt.value<250)return;qt.value=r,x.value=!x.value,n.preventDefault(),n.stopPropagation()}},!0),M.value){let e=0,n=0,r=0;t.addEventListener(`pointerdown`,t=>{t.pointerType!==`mouse`&&(e=t.clientX,n=t.clientY,r=Date.now())},{passive:!0}),t.addEventListener(`pointerup`,i=>{if(i.pointerType===`mouse`)return;let a=i.clientX-e,o=i.clientY-n,s=Date.now()-r;if(Math.abs(a)<70||Math.abs(o)>55||s>650)return;let c=t.getSelection?.();c&&c.toString().trim()||(a<0?Xt():Zt())},{passive:!0})}}))}async function Rn(e){if(!b.value)return;let t=M.value?{width:`100%`,height:`100%`,spread:`none`,manager:`default`,flow:`paginated`}:{width:`100%`,height:`100%`,spread:`none`,manager:`continuous`,flow:`scrolled-doc`};F=P.renderTo(b.value,t),Ln(),await F.display(e||j.value?.lastCfi||void 0),Ht()}let zn=r(!1);async function Bn(){if(!(!P||!b.value)&&!zn.value){zn.value=!0;try{let e=F?.location?.start?.cfi||j.value?.lastCfi;In(),await Rn(e),await B()}finally{zn.value=!1}}}a(M,async(e,t)=>{e!==t&&P&&await Bn()});async function Vn(){let e=(await me()).find(e=>e.id===_.id)||null;if(j.value=e,!e){oe.push(`/`);return}let t=await de(_.id);if(!t){oe.push(`/`);return}P=ge(await t.arrayBuffer()),await P.ready;try{P.spine.hooks.serialize.register(e=>e.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,``))}catch{}let n=await P.loaded.metadata,r=Pe(n?.title)||e.title,i=Pe(n?.creator)||e.author||``,a=``;try{let e=P.spine.items?.[0]?.href,t=await P.load(e);a=(new DOMParser().parseFromString(String(t),`text/html`).body?.textContent||``).slice(0,6e3)}catch{}Nt.value=ue(r,i,a),await Vt({title:r,author:i,profile:Nt.value}),Ut.value=P.navigation?.toc??[],await Rn(e.lastCfi||void 0),I=(await je(_.id)).id,_n()}async function Hn(){let e=await Ne(_.id);k(`Reading analytics`,`<p>Total: <b>${Math.round(e.totalSeconds/60)}</b> minutes across <b>${e.totalSessions}</b> sessions.</p>`)}return t(async()=>{if(window.addEventListener(`keydown`,Kt),X.value){Sn();try{window.speechSynthesis.onvoiceschanged=()=>Sn()}catch{}}A.value=await ce(_.id).catch(()=>pe),await Vn()}),n(async()=>{window.removeEventListener(`keydown`,Kt);try{In()}catch{}try{P?.destroy?.()}catch{}if(P=null,$(),I)try{await Me(_.id,I)}catch{}}),(t,n)=>(s(),v(`div`,Fe,[x.value?(s(),v(`div`,{key:0,ref_key:`topChromeEl`,ref:S,class:`fixed top-0 left-0 right-0 z-30 bg-base-200/95 backdrop-blur border-b border-base-300`},[g(`div`,Ie,[g(`div`,Le,[g(`button`,{class:`btn btn-ghost btn-sm`,onClick:Jt},[...n[19]||=[g(`i`,{class:`fa-solid fa-arrow-left mr-2`},null,-1),u(` Library `,-1)]]),g(`div`,Re,y(j.value?.title),1)]),g(`div`,ze,[g(`button`,{class:`btn btn-sm`,onClick:jt},[...n[20]||=[g(`i`,{class:`fa-solid fa-list mr-2`},null,-1),u(` TOC `,-1)]]),g(`button`,{class:`btn btn-sm`,onClick:m(ke,[`stop`])},[...n[21]||=[g(`i`,{class:`fa-solid fa-magnifying-glass mr-2`},null,-1),u(` Search `,-1)]]),g(`div`,Be,[g(`button`,{class:`btn btn-sm join-item`,disabled:!M.value,onClick:Zt,title:`Prev page`},`‹`,8,Ve),g(`button`,{class:`btn btn-sm join-item`,disabled:!M.value,onClick:Xt,title:`Next page`},`›`,8,He)]),g(`button`,{class:`btn btn-sm btn-outline`,onClick:Hn},[...n[22]||=[g(`i`,{class:`fa-solid fa-chart-column mr-2`},null,-1),u(` Stats `,-1)]]),X.value?(s(),v(`div`,Ue,[g(`button`,{class:i([`btn btn-sm join-item`,N.value?`btn-primary`:``]),onClick:En,title:`Enable Read Aloud`},[...n[23]||=[g(`i`,{class:`fa-solid fa-headphones`},null,-1)]],2),g(`button`,{class:`btn btn-sm join-item`,disabled:!N.value,onClick:n[0]||=e=>Z.value?Q.value?On():Dn():kn(),title:`Play / Pause`},[g(`i`,{class:i(Z.value&&!Q.value?`fa-solid fa-pause`:`fa-solid fa-play`)},null,2)],8,We),g(`button`,{class:`btn btn-sm join-item`,disabled:!N.value,onClick:$,title:`Stop`},[...n[24]||=[g(`i`,{class:`fa-solid fa-stop`},null,-1)]],8,Ge)])):p(``,!0)])])],512)):p(``,!0),g(`div`,{class:`h-full w-full`,style:l(xe.value)},[g(`div`,{ref_key:`viewer`,ref:b,class:i([`h-full w-full`,{"page-flip-next":H.value===`next`,"page-flip-prev":H.value===`prev`}])},null,2)],4),x.value?(s(),v(`div`,{key:1,ref_key:`bottomChromeEl`,ref:he,class:`fixed bottom-0 left-0 right-0 z-30 bg-base-200/95 backdrop-blur border-t border-base-300`,onClick:n[13]||=m(()=>{},[`stop`])},[g(`div`,Ke,[g(`label`,qe,[n[25]||=g(`div`,{class:`label`},[g(`span`,{class:`label-text`},`Font size`)],-1),c(g(`input`,{type:`range`,min:`80`,max:`180`,step:`5`,"onUpdate:modelValue":n[1]||=e=>A.value.fontSizePct=e,class:`range range-sm`},null,512),[[h,A.value.fontSizePct,void 0,{number:!0}]])]),g(`label`,Je,[n[26]||=g(`div`,{class:`label`},[g(`span`,{class:`label-text`},`Line height`)],-1),c(g(`input`,{type:`range`,min:`1.2`,max:`2.2`,step:`0.05`,"onUpdate:modelValue":n[2]||=e=>A.value.lineHeight=e,class:`range range-sm`},null,512),[[h,A.value.lineHeight,void 0,{number:!0}]])]),g(`label`,Ye,[n[27]||=g(`div`,{class:`label`},[g(`span`,{class:`label-text`},`Background`)],-1),c(g(`input`,{type:`color`,"onUpdate:modelValue":n[3]||=e=>A.value.bg=e,class:`input input-bordered h-10 p-1`},null,512),[[h,A.value.bg]])]),g(`label`,Xe,[n[28]||=g(`div`,{class:`label`},[g(`span`,{class:`label-text`},`Text`)],-1),c(g(`input`,{type:`color`,"onUpdate:modelValue":n[4]||=e=>A.value.fg=e,class:`input input-bordered h-10 p-1`},null,512),[[h,A.value.fg]])]),g(`label`,Ze,[n[30]||=g(`div`,{class:`label`},[g(`span`,{class:`label-text`},`Font`)],-1),c(g(`select`,{class:`select select-bordered`,"onUpdate:modelValue":n[5]||=e=>A.value.font=e},[...n[29]||=[g(`option`,{value:`ui-serif, Georgia, "Times New Roman", Times, serif`},`Serif`,-1),g(`option`,{value:`ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`},`Sans`,-1),g(`option`,{value:`ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace`},`Mono`,-1)]],512),[[re,A.value.font]])]),g(`label`,Qe,[n[32]||=g(`div`,{class:`label`},[g(`span`,{class:`label-text`},`Alignment`)],-1),c(g(`select`,{class:`select select-bordered`,"onUpdate:modelValue":n[6]||=e=>A.value.textAlign=e},[...n[31]||=[g(`option`,{value:`left`},`Left`,-1),g(`option`,{value:`justify`},`Justify`,-1),g(`option`,{value:`center`},`Center`,-1),g(`option`,{value:`right`},`Right`,-1)]],512),[[re,A.value.textAlign]])]),g(`div`,$e,[g(`label`,et,[n[33]||=g(`span`,{class:`label-text`},`Link color`,-1),c(g(`input`,{type:`color`,class:`input input-bordered h-10`,"onUpdate:modelValue":n[7]||=e=>A.value.noterefColor=e,onChange:V},null,544),[[h,A.value.noterefColor]])]),g(`label`,tt,[n[34]||=g(`span`,{class:`label-text`},`Underline links`,-1),c(g(`input`,{type:`checkbox`,class:`toggle`,"onUpdate:modelValue":n[8]||=e=>A.value.noterefUnderline=e,onChange:V},null,544),[[ee,A.value.noterefUnderline]])]),g(`div`,nt,[g(`label`,rt,[c(g(`input`,{type:`checkbox`,class:`toggle`,"onUpdate:modelValue":n[9]||=e=>A.value.studyMode=e,onChange:V},null,544),[[ee,A.value.studyMode]]),n[35]||=g(`span`,{class:`label-text`},`Study mode`,-1)])]),g(`div`,it,[g(`label`,at,[c(g(`input`,{type:`checkbox`,class:`toggle`,"onUpdate:modelValue":n[10]||=e=>M.value=e},null,512),[[ee,M.value]]),n[36]||=g(`span`,{class:`label-text`},`Real Book Feel (paginated + swipe)`,-1)])]),N.value&&X.value?(s(),v(`div`,ot,[n[38]||=g(`div`,{class:`label`},[g(`span`,{class:`label-text`},`Read aloud rate`)],-1),c(g(`input`,{type:`range`,min:`0.6`,max:`1.4`,step:`0.05`,"onUpdate:modelValue":n[11]||=e=>Pt.value=e,class:`range range-sm`},null,512),[[h,Pt.value,void 0,{number:!0}]]),g(`div`,st,[c(g(`select`,{class:`select select-bordered w-full`,"onUpdate:modelValue":n[12]||=e=>Ft.value=e},[n[37]||=g(`option`,{value:``},`Default voice`,-1),(s(!0),v(te,null,ne(xn.value,e=>(s(),v(`option`,{key:e.voiceURI,value:e.voiceURI},y(e.name)+` (`+y(e.lang)+`) `,9,ct))),128))],512),[[re,Ft.value]])])])):p(``,!0)])])],512)):p(``,!0),x.value?p(``,!0):(s(),v(`button`,{key:2,class:`fixed z-50 btn btn-sm btn-circle`,style:{top:`calc(env(safe-area-inset-top) + 0.75rem)`,right:`3.25rem`},onClick:m(ke,[`stop`]),"aria-label":`Search`},[...n[39]||=[g(`i`,{class:`fa-solid fa-magnifying-glass`},null,-1)]])),x.value?p(``,!0):(s(),v(`button`,{key:3,class:`fixed z-50 btn btn-sm opacity-80 hover:opacity-100`,style:{top:`calc(env(safe-area-inset-top) + 0.75rem)`,right:`0.75rem`},onClick:n[14]||=e=>x.value=!0,"aria-label":`Show controls`},` Show controls `)),D.value?(s(),v(`div`,lt,[g(`div`,ut,[g(`div`,{class:`flex items-center justify-between gap-3`},[n[40]||=g(`h3`,{class:`font-bold text-lg`},`Table of contents`,-1),g(`button`,{class:`btn btn-sm`,onClick:Mt},`Close`)]),g(`div`,dt,[(s(!0),v(te,null,ne(Wt.value,(e,t)=>(s(),v(`button`,{key:t,class:`btn btn-ghost btn-sm w-full justify-start text-left`,style:l({paddingLeft:`${e.depth*.75}rem`}),onClick:t=>Gt(e)},y(e.label),13,ft))),128))])]),g(`div`,{class:`modal-backdrop`,onClick:Mt})])):p(``,!0),e(se,{open:O.value,title:`Search`,onClose:Ae},{default:o(()=>[g(`div`,pt,[g(`div`,mt,[c(g(`input`,{ref_key:`searchInputEl`,ref:De,class:`input input-bordered join-item w-full`,placeholder:`Search…`,"onUpdate:modelValue":n[15]||=e=>G.value=e,onClick:n[16]||=m(()=>{},[`stop`])},null,512),[[h,G.value]]),g(`button`,{class:`btn btn-outline join-item`,disabled:!G.value.trim()||U.value||!W.value||J.value===0||q.value,onClick:n[17]||=m(e=>gn(-1),[`stop`]),"aria-label":`Previous match`},` ‹ `,8,ht),g(`button`,{class:`btn btn-outline join-item`,disabled:!G.value.trim()||U.value||!W.value||J.value===0||q.value,onClick:n[18]||=m(e=>gn(1),[`stop`]),"aria-label":`Next match`},` › `,8,gt)]),g(`div`,_t,[U.value?(s(),v(`span`,vt,`Indexing… `+y(Qt.value)+`/`+y($t.value),1)):(s(),v(`span`,yt,` Search ready (`+y(Object.keys(nn.value).length)+` chapters`+y(en.value?`, cached`:``)+`) `,1)),G.value.trim()&&J.value>0?(s(),v(`span`,bt,` Match `+y((Y.value?.global??-1)+1)+` / `+y(J.value),1)):p(``,!0)])]),G.value.trim()&&!U.value&&K.value.length?(s(),v(`div`,xt,[n[41]||=g(`div`,{class:`text-xs uppercase tracking-wide opacity-60 mb-2`},`Chapters with matches`,-1),g(`div`,St,[(s(!0),v(te,null,ne(K.value.slice(0,30),e=>(s(),v(`button`,{key:e.hrefKey,class:`w-full text-left p-3 rounded-xl bg-base-200 hover:bg-base-300`,onClick:t=>bn(e)},[g(`div`,wt,[g(`div`,Tt,y(e.count)+` hit(s)`,1),g(`div`,Et,y(e.hrefKey),1)]),g(`div`,Dt,y(e.snippet),1)],8,Ct))),128))])])):p(``,!0),G.value.trim()&&!U.value&&!K.value.length?(s(),v(`div`,Ot,` No matches. `)):p(``,!0)]),_:1},8,[`open`]),e(se,{open:w.value,title:T.value,onClose:Oe},{default:o(()=>[Ce.value?(s(),v(`div`,kt,`Loading…`)):(s(),v(`div`,{key:1,class:`space-y-2`,onClick:Nn,innerHTML:E.value},null,8,At))]),_:1},8,[`open`,`title`])]))}}),[[`__scopeId`,`data-v-7de07b46`]]);export{jt as default};